<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sketch → Slide</title>
  <script src="https://unpkg.com/pptxgenjs/dist/pptxgen.bundle.js"></script>
  <style>
    :root { --bg:#0b0c10; --card:#14161a; --fg:#f6f7fb; --muted:#9aa4b2; --accent:#4f8cff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg); }
    .wrap { max-width:960px; margin:32px auto; padding:16px; }
    .card { background:var(--card); border:1px solid #1f232a; border-radius:16px; padding:20px; }
    h1 { margin:0 0 6px; font-size:24px; }
    p { margin:0 0 14px; color:var(--muted); }
    .row { display:flex; flex-wrap:wrap; gap:16px; }
    .box { flex:1 1 420px; background:#0f1116; border:1px solid #22262d; border-radius:12px; padding:16px; }
    .btn { border:0; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; background:var(--accent); color:white; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .file { margin:8px 0 10px; }
    #preview { max-width:100%; border-radius:8px; border:1px solid #242932; display:none; }
    ul { margin:8px 0 0 20px; line-height:1.45; }
    #status { margin-top:8px; font-size:14px; color:#cbd5e1; min-height:1.2em; }
    .slide { background:#fff; color:#222; border-radius:8px; padding:18px; min-height:160px; }
    .tiny { color:#8da2b6; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Sketch → Slide</h1>
      <p>Upload a photo/scan of your hand-drawn slide. I’ll extract a title + bullets and generate a PowerPoint.</p>

      <div class="row">
        <div class="box">
          <strong>1) Upload</strong>
          <input id="file" class="file" type="file" accept="image/*"/>
          <img id="preview" alt="preview"/>
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button id="make" class="btn" disabled>Make my slide</button>
            <button id="download" class="btn" disabled>Download .pptx</button>
          </div>
          <div id="status"></div>
          <div class="tiny">Tip: use good lighting & straight-on photos.</div>
        </div>

        <div class="box">
          <strong>2) Preview</strong>
          <div class="slide" style="margin-top:10px;">
            <div id="title" style="font-size:22px; font-weight:800; margin-bottom:8px;">(title)</div>
            <ul id="bullets"></ul>
            <div id="notes" class="tiny"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const fileEl = $("#file"), imgEl = $("#preview");
const makeBtn = $("#make"), dlBtn = $("#download");
const statusEl = $("#status"), titleEl = $("#title");
const bulletsEl = $("#bullets"), notesEl = $("#notes");

let lastSpec = null;

fileEl.addEventListener("change", async ev => {
  const f = ev.target.files?.[0];
  if (!f) return;
  const url = await fileToDataUrl(f);
  imgEl.src = url;
  imgEl.style.display = "block";
  makeBtn.disabled = false;
  status("Ready. Click “Make my slide”.");
});

makeBtn.addEventListener("click", async () => {
  const src = imgEl.src || "";
  if (!src.startsWith("data:image")) return status("Please upload an image first.");

  toggleBusy(true);
  status("Analyzing sketch…");
  try {
    const res = await fetch("/api/slide", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageDataUrl: src })
    });
    if (!res.ok) throw new Error(`Server ${res.status}`);
    const spec = await res.json(); // {title, bullets[], notes}
    lastSpec = spec;
    render(spec);
    status("Done! You can download the PPTX.");
    dlBtn.disabled = false;
  } catch (e) {
    console.error(e);
    status("Something went wrong. Try a clearer photo and retry.");
  } finally {
    toggleBusy(false);
  }
});

dlBtn.addEventListener("click", async () => {
  if (!lastSpec) return;
  const pptx = new PptxGenJS();
  pptx.layout = "LAYOUT_16x9";
  const s = pptx.addSlide();
  const title = (lastSpec.title || "Untitled").trim();
  const bullets = Array.isArray(lastSpec.bullets) ? lastSpec.bullets : [];
  const notes = lastSpec.notes || "";

  s.addText(title, { x:0.5, y:0.5, w:9, h:1, bold:true, fontSize:28, color:"1F2937" });
  const bulletText = bullets.map(b => ({ text:"• " + b }));
  s.addText(bulletText, { x:0.9, y:1.4, w:8.2, h:4.6, fontSize:18, color:"374151", lineSpacingMultiple:1.2 });
  if (notes) s.addNotes(notes);

  const safe = title.replace(/[^\w\d\- ]+/g,"").slice(0,40) || "slide";
  await pptx.writeFile({ fileName: `${safe}.pptx` });
});

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}
function render(spec){
  titleEl.textContent = spec.title || "(no title detected)";
  bulletsEl.innerHTML = "";
  (spec.bullets || []).forEach(b => {
    const li = document.createElement("li");
    li.textContent = b;
    bulletsEl.appendChild(li);
  });
  notesEl.textContent = spec.notes || "";
}
function status(msg){ statusEl.textContent = msg; }
function toggleBusy(b){ makeBtn.disabled = b; }
</script>
</body>
</html>
